<!doctype html>
<html lang="de">
  <head>
    <link
      rel="icon"
      href="https://i.ibb.co/21R6p75W/Logo-1.jpg"
      type="image/jpeg"
    />
    <meta charset="UTF-8" />
    <title>GoalNews â€“ Benutzer Dashboard</title>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 900px;
        background: white;
        margin: 40px auto;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.1);
      }
      h2 {
        color: #1db954;
        margin-bottom: 10px;
      }
      label {
        font-weight: 600;
        margin-top: 15px;
        display: block;
      }
      input {
        width: 100%;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-top: 6px;
        font-size: 15px;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        padding: 12px;
        margin-top: 20px;
        border: none;
        border-radius: 6px;
        background: #1db954;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
      }
      button:hover {
        background: #169b48;
      }
      .successMsg {
        margin-top: 10px;
        color: #1db954;
        font-weight: 600;
      }
      .adminBox {
        display: none;
        margin-top: 40px;
      }
      .admin-header {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: #1db954;
      }
      .admin-container {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .user-card {
        background: #eefbea;
        border-left: 5px solid #1db954;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        flex: 1 1 200px;
        transition: 0.2s;
      }
      .user-card:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }
      .user-card p {
        margin: 5px 0;
        font-weight: 600;
      }
      .admin-actions {
        flex: 1 1 350px;
        background: #f0f0f0;
        border-radius: 8px;
        padding: 15px;
        height: fit-content;
      }
      .admin-actions label {
        margin-top: 10px;
      }
      #personalMsg {
        max-height: 200px;
        overflow-y: auto;
      }
      #personalMsg p {
        margin: 4px 0;
        padding: 4px 6px;
        background: #d8f0d8;
        border-radius: 4px;
      }
      /* ===== Footer ===== */
      footer {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 15px 10px;
        background-color: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        font-size: 14px;
        text-align: center;
      }

      footer a {
        color: #ffcc00;
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      @media (max-width: 480px) {
        footer {
          flex-direction: column;
          gap: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Willkommen im Dashboard</h2>
      <p><b id="username">User</b>, schÃ¶n dass du da bist!</p>

      <a href="https://goalnews.website">
        <button id="logoutBtn" style="background: #f44336">Logout</button>
      </a>
      <label>Dein Lieblingsverein:</label>
      <input id="favTeamInput" placeholder="z. B. Bayern MÃ¼nchen" />
      <button id="saveTeamBtn">Verein speichern</button>
      <div class="successMsg" id="saveTeamMsg" style="display: none">
        âœ” Lieblingsverein gespeichert!
      </div>

      <label>Deine Coins:</label>
      <p id="userCoins">0</p>

      <a href="dailyspin.html">TÃ¤gliche Belohnung</a>

      <!-- ðŸ”¥ BREAKING NEWS NEUER BEREICH -->
      <label>ðŸ”¥ Breaking News Leiste kaufen (3000 Coins):</label>
      <button id="buyBreakingBtn">Jetzt kaufen</button>
      <div class="successMsg" id="buyBreakingMsg" style="display: none">
        âœ” Breaking News aktiviert!
      </div>
      <!-- ðŸ”¥ ENDE -->

      <label>Deine Nachrichten:</label>
      <div
        id="personalMsg"
        style="
          padding: 12px;
          background: #f0f0f0;
          border-radius: 6px;
          margin-top: 5px;
        "
      >
        Noch keine Nachricht erhalten.
      </div>

      <footer>
        Â© 2026 GoalNews | Built by piex_ and EliXTech |
        <a href="https://goalnews.website/impressum">Impressum</a> |
        <a href="https://goalnews.website/agb.html">AGB</a> |
        <a href="https://goalnews.website/datenschutz.html">Datenschutz</a>
      </footer>

      <!-- Admin Bereich -->
      <div class="adminBox" id="adminBox">
        <div class="admin-header">ðŸ”’ Admin â€“ Benutzer Ãœbersicht</div>
        <div class="admin-container">
          <div id="usersList"></div>
          <div class="admin-actions">
            <h3>Aktionen fÃ¼r ausgewÃ¤hlten Benutzer</h3>
            <p id="selectedUserName">Bitte Benutzer auswÃ¤hlen</p>

            <label>Nachricht senden:</label>
            <input id="adminMsgInput" placeholder="Nachricht schreiben" />
            <button id="sendMsgBtn">Nachricht senden</button>

            <label>Coins vergeben:</label>
            <input
              type="number"
              id="addCoinsInput"
              placeholder="Anzahl Coins"
            />
            <button id="addCoinsBtn">Coins vergeben</button>

            <label>Username Ã¤ndern:</label>
            <input id="changeNameInput" placeholder="Neuer Username" />
            <button id="changeNameBtn">Username Ã¤ndern</button>

            <label>Start-Belohnung an alle:</label>
            <input
              type="number"
              id="startRewardInput"
              placeholder="Anzahl Coins"
            />
            <button id="startRewardBtn">Start-Belohnung senden</button>

            <div class="successMsg" id="actionMsg" style="display: none">
              âœ” Aktion erfolgreich!
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        updateDoc,
        onSnapshot,
        arrayUnion,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBmIcdFtxv4jBJKdiAkEiwnkQ8yRwiG_0w",
        authDomain: "goalnewsde-community.firebaseapp.com",
        projectId: "goalnewsde-community",
        storageBucket: "goalnewsde-community.firebasestorage.app",
        messagingSenderId: "134523022055",
        appId: "1:134523022055:web:4f35ed7812d06e4fb55042",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // ðŸ”’ Nur eingeloggte User dÃ¼rfen special.html sehen
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "/404.html"; // nicht eingeloggte User weiterleiten
        }
      });
      const ADMIN_UIDS = ["5Oe5YOBOtfOGQsRJ3XUjr3kemnX2"];

      const favTeamInput = document.getElementById("favTeamInput");
      const saveTeamBtn = document.getElementById("saveTeamBtn");
      const saveTeamMsg = document.getElementById("saveTeamMsg");
      const personalMsg = document.getElementById("personalMsg");
      const userCoinsElem = document.getElementById("userCoins");
      const usernameField = document.getElementById("username");

      const buyBreakingBtn = document.getElementById("buyBreakingBtn");
      const buyBreakingMsg = document.getElementById("buyBreakingMsg");

      const adminBox = document.getElementById("adminBox");
      const usersList = document.getElementById("usersList");
      const selectedUserNameElem = document.getElementById("selectedUserName");
      const adminMsgInput = document.getElementById("adminMsgInput");
      const sendMsgBtn = document.getElementById("sendMsgBtn");
      const addCoinsInput = document.getElementById("addCoinsInput");
      const addCoinsBtn = document.getElementById("addCoinsBtn");
      const changeNameInput = document.getElementById("changeNameInput");
      const changeNameBtn = document.getElementById("changeNameBtn");
      const startRewardInput = document.getElementById("startRewardInput");
      const startRewardBtn = document.getElementById("startRewardBtn");
      const actionMsg = document.getElementById("actionMsg");

      const logoutBtn = document.getElementById("logoutBtn");

      let selectedUserId = null;

      // Sicherstellen, dass Login persistiert wird
      setPersistence(auth, browserLocalPersistence);

      // LOGIN + Admin Check
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        const userRef = doc(db, "users", user.uid);

        // Live-Update fÃ¼r eigenen Benutzer
        onSnapshot(userRef, (userDocSnap) => {
          const data = userDocSnap.data();
          if (!data) return;
          usernameField.textContent = data.username || "User";
          userCoinsElem.textContent = data.coins || 0;
          favTeamInput.value = data.favTeam || "";

          if (data.breakingNews === true) buyBreakingBtn.style.display = "none";

          personalMsg.innerHTML = "";
          if (data.messages && data.messages.length > 0) {
            data.messages.forEach((msg) => {
              const p = document.createElement("p");
              p.textContent = msg;
              personalMsg.appendChild(p);
            });
          } else {
            personalMsg.textContent = "Noch keine Nachricht erhalten.";
          }
        });

        if (ADMIN_UIDS.includes(user.uid)) adminBox.style.display = "block";

        // Admin: Benutzer Ãœbersicht
        if (ADMIN_UIDS.includes(user.uid)) {
          const usersCol = collection(db, "users");
          onSnapshot(usersCol, (snapshot) => {
            usersList.innerHTML = "";

            const allCard = document.createElement("div");
            allCard.className = "user-card";
            allCard.innerHTML =
              "<p>Alle Benutzer</p><p>Aktionen an alle senden</p>";
            allCard.onclick = () => {
              selectedUserId = null;
              selectedUserNameElem.textContent = "Alle Benutzer";
            };
            usersList.appendChild(allCard);

            snapshot.docs.forEach((docSnap) => {
              const data = docSnap.data();
              const card = document.createElement("div");
              card.className = "user-card";
              card.innerHTML = `<p>${data.username || "User"}</p><p>Coins: ${
                data.coins || 0
              }</p><p>Verein: ${data.favTeam || "-"}</p>`;
              card.onclick = () => {
                selectedUserId = docSnap.id;
                selectedUserNameElem.textContent = `Benutzer: ${data.username}`;
                adminMsgInput.value = "";
                addCoinsInput.value = "";
                changeNameInput.value = "";
              };
              usersList.appendChild(card);
            });
          });
        }
      });

      // Logout
      logoutBtn.onclick = async () => {
        await signOut(auth);
        window.location.href = "login.html";
      };

      // Lieblingsverein speichern
      saveTeamBtn.onclick = async () => {
        const user = auth.currentUser;
        if (!user) return;
        await updateDoc(doc(db, "users", user.uid), {
          favTeam: favTeamInput.value,
        });
        saveTeamMsg.style.display = "block";
        setTimeout(() => (saveTeamMsg.style.display = "none"), 2000);
      };

      // ðŸ”¥ BREAKING NEWS KAUF FUNKTION
      buyBreakingBtn.onclick = async () => {
        const user = auth.currentUser;
        if (!user) return;

        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        const data = snap.data();
        const coins = data.coins || 0;

        if (data.breakingNews === true) {
          alert("Du hast die Breaking News Leiste schon gekauft.");
          return;
        }

        if (coins < 3000) {
          alert("Du brauchst 3000 Coins!");
          return;
        }

        await updateDoc(userRef, { coins: coins - 3000, breakingNews: true });

        buyBreakingMsg.style.display = "block";
        setTimeout(() => (buyBreakingMsg.style.display = "none"), 2000);
        buyBreakingBtn.style.display = "none";
      };

      // Nachricht senden
      sendMsgBtn.onclick = async () => {
        if (adminMsgInput.value === "") return;
        const msg = adminMsgInput.value;
        if (selectedUserId === null) {
          const snapshot = await getDocs(collection(db, "users"));
          snapshot.docs.forEach(async (docSnap) => {
            await updateDoc(doc(db, "users", docSnap.id), {
              messages: arrayUnion(msg),
            });
          });
        } else {
          await updateDoc(doc(db, "users", selectedUserId), {
            messages: arrayUnion(msg),
          });
        }
        actionMsg.style.display = "block";
        setTimeout(() => (actionMsg.style.display = "none"), 2000);
      };

      // Coins vergeben
      addCoinsBtn.onclick = async () => {
        const amount = parseInt(addCoinsInput.value);
        if (isNaN(amount)) return;

        if (selectedUserId === null) {
          const snapshot = await getDocs(collection(db, "users"));
          snapshot.docs.forEach(async (docSnap) => {
            const userRef = doc(db, "users", docSnap.id);
            const coins = docSnap.data().coins || 0;
            await updateDoc(userRef, { coins: coins + amount });
          });
        } else {
          const userRef = doc(db, "users", selectedUserId);
          const userDoc = await getDoc(userRef);
          const coins = userDoc.data().coins || 0;
          await updateDoc(userRef, { coins: coins + amount });
        }

        actionMsg.style.display = "block";
        setTimeout(() => (actionMsg.style.display = "none"), 2000);
      };

      // Username Ã¤ndern
      changeNameBtn.onclick = async () => {
        const newName = changeNameInput.value.trim();
        if (!newName) return;
        if (!selectedUserId) {
          alert("Bitte einen Benutzer auswÃ¤hlen.");
          return;
        }

        const userRef = doc(db, "users", selectedUserId);
        const userDoc = await getDoc(userRef);
        const coins = userDoc.data().coins || 0;
        const currentUser = auth.currentUser;

        if (ADMIN_UIDS.includes(currentUser.uid)) {
          await updateDoc(userRef, { username: newName });
        } else {
          if (coins < 400) {
            alert("Du brauchst 400 Coins zum Ã„ndern des Usernames.");
            return;
          }
          await updateDoc(userRef, { username: newName, coins: coins - 400 });
        }

        actionMsg.style.display = "block";
        setTimeout(() => (actionMsg.style.display = "none"), 2000);
      };

      // Start-Belohnung an alle
      startRewardBtn.onclick = async () => {
        const amount = parseInt(startRewardInput.value);
        if (isNaN(amount)) return;
        const snapshot = await getDocs(collection(db, "users"));
        snapshot.docs.forEach(async (docSnap) => {
          const userRef = doc(db, "users", docSnap.id);
          const coins = docSnap.data().coins || 0;
          await updateDoc(userRef, { coins: coins + amount });
        });
        actionMsg.style.display = "block";
        setTimeout(() => (actionMsg.style.display = "none"), 2000);
      };
    </script>
  </body>
</html>
