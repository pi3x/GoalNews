<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GoalNews - Live Spiele</title>
<style>
body { font-family: 'Poppins', sans-serif; background:#0f0f0f; color:#eee; text-align:center; }
h2 { margin:20px 0; }
.matches-table { width:90%; max-width:800px; margin:20px auto; border-collapse: collapse; }
.matches-table th, .matches-table td { border:1px solid #444; padding:10px; text-align:center; transition: all 0.5s ease; }
.matches-table th { background:#1db954; color:#000; }
.goal-animation { background: #00ff00; color:#000; font-weight:bold; transform: scale(1.2); animation: pop 0.5s forwards; }
.over-game { text-decoration: line-through; opacity: 0.6; transition: all 0.5s ease; }
@keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.5); } 100% { transform: scale(1.2); } }
#nextGameCountdown { font-size: 1.5rem; margin: 15px 0; color:#1db954; }
footer { margin-top:30px; padding:15px; background:#111; color:#eee; }
</style>
</head>
<body>

<h2> Live Spiele</h2>
<p>Alle Spiele sind Live und noch im Gange</p>
<p>Durchgestrichene Spiele sind beendet </p>
<p id="nextGameCountdown">Lade nächsten Countdown...</p>

<table class="matches-table">
<thead>
<tr><th>Heimteam</th><th>Gastteam</th><th>Ergebnis</th></tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="3">Lade Spiele...</td></tr>
</tbody>
</table>

<footer>GoalNews © 2025</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
    apiKey: "AIzaSyBmIcdFtxv4jBJKdiAkEiwnkQ8yRwiG_0w",
    authDomain: "goalnewsde-community.firebaseapp.com",
    projectId: "goalnewsde-community",
    storageBucket: "goalnewsde-community.firebasestorage.app",
    messagingSenderId: "134523022055",
    appId: "1:134523022055:web:4f35ed7812d06e4fb55042"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tableBody = document.getElementById("tableBody");
const countdownEl = document.getElementById("nextGameCountdown");

// --- Funktion um Sammlung automatisch anzulegen ---
async function ensureCollectionExists(collectionName) {
    const docRef = doc(db, collectionName, "initDoc");
    await setDoc(docRef, { init: true });
}

// --- Countdown Update ---
function updateCountdown(nextGameTime) {
    const now = new Date().getTime();
    const diff = nextGameTime - now;

    if(diff <= 0){
        countdownEl.textContent = "Das nächste Spiel läuft!";
        return;
    }

    const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
    const seconds = Math.floor((diff % (1000*60)) / 1000);
    const milliseconds = Math.floor(diff % 1000);
    countdownEl.textContent = `Nächstes Spiel in ${minutes}m ${seconds}s ${milliseconds}ms`;
}

// --- Live-Spiele anzeigen ---
async function initLiveGames() {
    const collectionName = "liveGames";
    await ensureCollectionExists(collectionName);

    const colRef = collection(db, collectionName);

    // --- Live-Spiele Snapshot ---
    onSnapshot(colRef, async (snapshot) => {
        tableBody.innerHTML = "";
        if(snapshot.empty){
            tableBody.innerHTML = "<tr><td colspan='3'>Keine aktuellen Spiele</td></tr>";
            countdownEl.textContent = "";
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const home = data.home || "";
            const away = data.away || "";
            const score = data.score || "";
            const goal = data.goal || false;
            const over = data.over || false;

            // Skip next_game für die Tabelle
            if(doc.id === "next_game") return;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="${over ? 'over-game' : ''}">${home}</td>
                <td class="${over ? 'over-game' : ''}">${away}</td>
                <td class="${goal ? 'goal-animation' : ''} ${over ? 'over-game' : ''}">${score}</td>
            `;
            tableBody.appendChild(tr);
        });

        // --- Countdown für next_game ---
        const nextGameDoc = doc(db, collectionName, "next_game");
        const nextSnap = await getDoc(nextGameDoc);
        if(nextSnap.exists()){
            const data = nextSnap.data();
            if(data.nextGameTime){
                const nextGameTime = data.nextGameTime.toDate().getTime(); // Firestore Timestamp -> JS Date
                clearInterval(window.nextGameInterval);
                updateCountdown(nextGameTime);
                window.nextGameInterval = setInterval(() => updateCountdown(nextGameTime), 50);
            }
        }
    });
}

initLiveGames();
</script>
</body>
</html>
